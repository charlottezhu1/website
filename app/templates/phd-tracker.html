<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PhD Applications Tracker - Charlotte Zhu</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="blog, writing, AI, Charlotte" />
    <meta name="author" content="Charlotte Zhu" />
    <meta
      name="description"
      content="PhD Applications Tracker - Charlotte Zhu"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="wrapper">
      <div class="navbar container">
        <a id="author-name" class="alignable pull-left" href="/"
          >Charlotte Zhu</a
        >
        <ul id="navlist" class="alignable pull-right navbar-ul">
          <li class="alignable pull-left nav-list"><a href="/">About</a> /</li>
          <li class="alignable pull-left nav-list">
            <a href="{{ url_for('index.research') }}">Research</a> /
          </li>
          <li class="alignable pull-left nav-list">
            <a
              href="https://docs.google.com/document/d/1glz4mQ6Plw6i5HLSvEICBq8n1f0msbjSDgCIvIjnX8k/edit?usp=sharing"
              target="_blank"
              >CV</a
            >
            /
          </li>
          <li class="alignable pull-left nav-list">
            <div class="dropdown">
              <button class="dropdown-btn" onclick="toggleDropdown()">
                Funzzies
              </button>
              <div class="dropdown-content" id="funzziesDropdown">
                <a href="{{ url_for('chat.chat') }}">Chat</a>
                <a href="{{ url_for('index.drawings') }}">Drawings</a>
                <a href="{{ url_for('index.photos') }}">Photos</a>
                <a href="{{ url_for('index.writings') }}">Writings</a>
                <a href="{{ url_for('index.phd_tracker') }}">PhD Tracker</a>
              </div>
            </div>
          </li>
        </ul>
      </div>
      <div style="clear: both"></div>
      <hr />

      <div class="container content">
        <h1>PhD Applications Tracker</h1>
        <p class="highlight">
          Track your PhD application progress and deadlines
        </p>

        <div class="tracker-controls">
          <button class="primary-btn" onclick="addNewRow()">
            Add New Application
          </button>
          <button class="secondary-btn" onclick="exportToCSV()">
            Export to CSV
          </button>
        </div>

        <div class="tracker-container">
          <table class="tracker-table" id="applicationsTable">
            <thead>
              <tr>
                <th>Advisor Name</th>
                <th>Field</th>
                <th>Contact</th>
                <th>University Name</th>
                <th>Program Link</th>
                <th>Application Deadline</th>
                <th>Requirements Status</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="applicationsBody">
              <!-- Data will be loaded here -->
            </tbody>
          </table>
        </div>

        <div class="tracker-stats">
          <div class="stat-card">
            <h4>Total Applications</h4>
            <span id="totalCount">0</span>
          </div>
          <div class="stat-card">
            <h4>Pending</h4>
            <span id="pendingCount">0</span>
          </div>
          <div class="stat-card">
            <h4>In Progress</h4>
            <span id="inProgressCount">0</span>
          </div>
          <div class="stat-card">
            <h4>Submitted</h4>
            <span id="submittedCount">0</span>
          </div>
          <div class="stat-card">
            <h4>Upcoming Deadlines</h4>
            <span id="upcomingCount">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="applicationModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h4 id="modalTitle">Add New Application</h4>
        <form id="applicationForm" class="tracker-form">
          <input type="hidden" id="applicationId" />
          <div class="form-group">
            <label for="advisorName">Advisor Name</label>
            <input type="text" id="advisorName" name="advisor_name" required />
          </div>
          <div class="form-group">
            <label for="field">Field</label>
            <input type="text" id="field" name="field" required />
          </div>
          <div class="form-group">
            <label for="contact">Contact</label>
            <input type="text" id="contact" name="contact" />
          </div>
          <div class="form-group">
            <label for="universityName">University Name</label>
            <input
              type="text"
              id="universityName"
              name="university_name"
              required
            />
          </div>
          <div class="form-group">
            <label for="programLink">Program Link</label>
            <input type="url" id="programLink" name="program_link" />
          </div>
          <div class="form-group">
            <label for="applicationDeadline">Application Deadline</label>
            <input
              type="date"
              id="applicationDeadline"
              name="application_deadline"
            />
          </div>
          <div class="form-group">
            <label for="requirementsStatus">Requirements Status</label>
            <textarea
              id="requirementsStatus"
              name="application_requirements_status"
              rows="3"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status">
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="submitted">Submitted</option>
              <option value="accepted">Accepted</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <div class="form-group">
            <label for="priority">Priority</label>
            <select id="priority" name="priority">
              <option value="1">High</option>
              <option value="2">Medium</option>
              <option value="3" selected>Low</option>
            </select>
          </div>
          <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" rows="3"></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="primary-btn">Save</button>
            <button type="button" class="secondary-btn" onclick="closeModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let applications = [];

      // Load applications on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadApplications();
      });

      function toggleDropdown() {
        const dropdown = document.querySelector(".dropdown");
        dropdown.classList.toggle("show");
      }

      // Close dropdown when clicking outside
      window.onclick = function (event) {
        if (!event.target.matches(".dropdown-btn")) {
          const dropdowns = document.getElementsByClassName("dropdown");
          for (let dropdown of dropdowns) {
            if (dropdown.classList.contains("show")) {
              dropdown.classList.remove("show");
            }
          }
        }
      };

      async function loadApplications() {
        try {
          const response = await fetch("/api/phd-applications");
          if (response.ok) {
            applications = await response.json();
            renderApplications();
            updateStats();
          } else {
            console.error("Failed to load applications");
          }
        } catch (error) {
          console.error("Error loading applications:", error);
        }
      }

      function renderApplications() {
        const tbody = document.getElementById("applicationsBody");
        tbody.innerHTML = "";

        applications.forEach((app) => {
          const row = document.createElement("tr");
          row.className = `status-${app.status}`;
          if (app.application_deadline) {
            const deadline = new Date(app.application_deadline);
            const today = new Date();
            if (deadline < today && app.status === "pending") {
              row.classList.add("overdue");
            }
          }

          row.innerHTML = `
            <td>${app.advisor_name || ""}</td>
            <td>${app.field || ""}</td>
            <td>${app.contact || ""}</td>
            <td>${app.university_name || ""}</td>
            <td>${
              app.program_link
                ? `<a href="${app.program_link}" target="_blank">Link</a>`
                : ""
            }</td>
            <td>${app.application_deadline || ""}</td>
            <td>${app.application_requirements_status || ""}</td>
            <td><span class="status-badge status-${app.status}">${formatStatus(
            app.status
          )}</span></td>
            <td><span class="priority-badge priority-${
              app.priority
            }">${formatPriority(app.priority)}</span></td>
            <td>${app.notes || ""}</td>
            <td>
              <button class="action-btn edit-btn" onclick="editApplication('${
                app.id
              }')">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteApplication('${
                app.id
              }')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      function formatStatus(status) {
        const statusMap = {
          pending: "Pending",
          in_progress: "In Progress",
          submitted: "Submitted",
          accepted: "Accepted",
          rejected: "Rejected",
        };
        return statusMap[status] || status;
      }

      function formatPriority(priority) {
        const priorityMap = {
          1: "High",
          2: "Medium",
          3: "Low",
        };
        return priorityMap[priority] || priority;
      }

      function updateStats() {
        const total = applications.length;
        const pending = applications.filter(
          (app) => app.status === "pending"
        ).length;
        const inProgress = applications.filter(
          (app) => app.status === "in_progress"
        ).length;
        const submitted = applications.filter(
          (app) => app.status === "submitted"
        ).length;

        const today = new Date();
        const upcoming = applications.filter((app) => {
          if (!app.application_deadline || app.status !== "pending")
            return false;
          const deadline = new Date(app.application_deadline);
          const diffTime = deadline - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays >= 0 && diffDays <= 30;
        }).length;

        document.getElementById("totalCount").textContent = total;
        document.getElementById("pendingCount").textContent = pending;
        document.getElementById("inProgressCount").textContent = inProgress;
        document.getElementById("submittedCount").textContent = submitted;
        document.getElementById("upcomingCount").textContent = upcoming;
      }

      function addNewRow() {
        document.getElementById("modalTitle").textContent =
          "Add New Application";
        document.getElementById("applicationForm").reset();
        document.getElementById("applicationId").value = "";
        document.getElementById("applicationModal").style.display = "block";
      }

      function editApplication(id) {
        const app = applications.find((a) => a.id === id);
        if (!app) return;

        document.getElementById("modalTitle").textContent = "Edit Application";
        document.getElementById("applicationId").value = app.id;
        document.getElementById("advisorName").value = app.advisor_name || "";
        document.getElementById("field").value = app.field || "";
        document.getElementById("contact").value = app.contact || "";
        document.getElementById("universityName").value =
          app.university_name || "";
        document.getElementById("programLink").value = app.program_link || "";
        document.getElementById("applicationDeadline").value =
          app.application_deadline || "";
        document.getElementById("requirementsStatus").value =
          app.application_requirements_status || "";
        document.getElementById("status").value = app.status || "pending";
        document.getElementById("priority").value = app.priority || "3";
        document.getElementById("notes").value = app.notes || "";

        document.getElementById("applicationModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("applicationModal").style.display = "none";
      }

      async function deleteApplication(id) {
        if (!confirm("Are you sure you want to delete this application?"))
          return;

        try {
          const response = await fetch(`/api/phd-applications/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            await loadApplications();
          } else {
            console.error("Failed to delete application");
          }
        } catch (error) {
          console.error("Error deleting application:", error);
        }
      }

      document
        .getElementById("applicationForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());

          const id = document.getElementById("applicationId").value;
          const url = id
            ? `/api/phd-applications/${id}`
            : "/api/phd-applications";
          const method = id ? "PUT" : "POST";

          try {
            const response = await fetch(url, {
              method: method,
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              closeModal();
              await loadApplications();
            } else {
              console.error("Failed to save application");
            }
          } catch (error) {
            console.error("Error saving application:", error);
          }
        });

      function exportToCSV() {
        const headers = [
          "Advisor Name",
          "Field",
          "Contact",
          "University Name",
          "Program Link",
          "Application Deadline",
          "Requirements Status",
          "Status",
          "Priority",
          "Notes",
        ];
        const csvContent = [
          headers.join(","),
          ...applications.map((app) =>
            [
              `"${app.advisor_name || ""}"`,
              `"${app.field || ""}"`,
              `"${app.contact || ""}"`,
              `"${app.university_name || ""}"`,
              `"${app.program_link || ""}"`,
              `"${app.application_deadline || ""}"`,
              `"${app.application_requirements_status || ""}"`,
              `"${formatStatus(app.status)}"`,
              `"${formatPriority(app.priority)}"`,
              `"${app.notes || ""}"`,
            ].join(",")
          ),
        ].join("\n");

        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "phd_applications.csv";
        a.click();
        window.URL.revokeObjectURL(url);
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("applicationModal");
        if (event.target === modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
